---
title: "map species distributions"
author: "Kimberly Ledger"
date: "2024-07-12"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


load libraries
```{r}
library(tidyverse)
library(rnaturalearth)
library(rnaturalearthdata)
world <- ne_countries(scale = "medium", returnclass = "sf")
```

load data
```{r}
taxon_table <- read.csv("/home/kimberly.ledger/BeringSea_Arctic_eDNA/outputs/taxon_table.csv")
```

by using this output any sites with no reads have been removed - will need to think about how to visualize sampling effort vs where we got data from 
```{r}
pres_table <- taxon_table %>%
  filter(sample_type == "sample") %>%
  filter(project_year != "DBO_2023") %>%   ## no metadata for this yet 
  group_by(project, collection_year, location1, depth, longitude, latitude, taxon) %>%
  summarize(n_reps_present = sum(reads > 0)) %>%
  mutate(n_reps_present = ifelse(n_reps_present > 3, 3, n_reps_present))    ### just to get rid of the multiple SBS reps 
```

```{r}
spp <- pres_table %>%
  #filter(taxon == "Lepidopsetta")
  #filter(taxon == "Anoplopoma fimbria")
  #filter(taxon == "Limanda aspera")
  #filter(taxon == "Reinhardtius hippoglossoides")
  #filter(taxon == "Atheresthes")  #arrowtooth flounder - other spp? Kamchatka flounder
  #filter(taxon == "Hippoglossoides")
  #filter(taxon == "Mallotus villosus")
  filter(taxon == "Clupea pallasii")
```


plot 
```{r,echo=FALSE,warning=FALSE, fig.height= 8, fig.width= 12}
min_lat <- min(spp$latitude, na.rm = T)
max_lat <- max(spp$latitude, na.rm = T)

min_lon <- min(spp$longitude, na.rm = T)
max_lon <- max(spp$longitude, na.rm = T)

spp$collection_year <- as.factor(spp$collection_year)
spp$n_reps_present <- as.factor(spp$n_reps_present)

#bin the 30-60m depth samples to make a figure with fewer grids
spp <- spp %>%
  #mutate(depth2 = as.character(depth)) %>%
  mutate(depth2 = ifelse(depth == 30, "30 to 60 & bottom", depth),
         depth2 = ifelse(depth == 40, "30 to 60 & bottom", depth2),
         depth2 = ifelse(depth == 50, "30 to 60 & bottom", depth2),
         depth2 = ifelse(depth == 60, "30 to 60 & bottom", depth2),
         depth2 = ifelse(depth == 0, "0 to 10", depth2),
         depth2 = ifelse(depth == 10, "0 to 10", depth2),
         depth2 = ifelse(depth == "bottom", "30 to 60 & bottom", depth2))

spp_plot <- ggplot(data = world) +
    geom_sf() +
    geom_point(data = spp, aes(x = longitude, y = latitude, color= n_reps_present)) + 
  coord_sf(xlim = c(min_lon-2, max_lon+2), ylim = c(min_lat-1, max_lat+1), expand = FALSE) +
  theme_bw() +xlab("Longitude") +ylab("Latitude") +
  facet_grid(depth2~collection_year) + 
  labs(title = spp$taxon) +
  theme(axis.text.x = element_text(angle = 90))

spp_plot

#ggsave(plot= BeringSea_plot, 
#      filename = ("~/NBS_eDNA_sample_map/figures/BeringSea_plot.png"),
#      width=12,
#      height = 8,
#      dpi = 300,
#      units = c("in"))
```


okay, i don't have lat/long for DBO samples but i'm curious how those stations/lines look 

i recently added location info to the metadata so it's not in the current output of the taxon table. let me re-join with the updated verision here. 

```{r}
metadata_new <- read.csv("/home/kimberly.ledger/BeringSea_Arctic_eDNA/data/NBS_SBS_DBO_metadata.csv")
```

join and select just DBO2023 samples 
```{r}
dbo23 <- taxon_table %>%
  filter(project_year == "DBO_2023") %>% 
  select(!location1) %>%
  left_join(metadata_new)
```

plot station1 
```{r}
dbo23 %>%
  filter(location2 == "DBO_1") %>%
  filter(reads > 0) %>%
  ggplot(aes(x=extraction_ID, y=reads, fill=taxon)) +
  geom_bar(stat = "identity") + 
  theme_bw() +
  facet_grid(~location1, scales = "free_x") + 
  labs(
    y = "number of sequencing reads",
    x = "sample ID",
    title = "DBO Station 1 - 2023") + 
  theme(
    axis.text.x = element_text(angle = 90, hjust = 0.95),
    legend.text = element_text(size = 8),
    legend.key.size = unit(0.3, "cm"),
    legend.position = "bottom",
    legend.title = element_blank()
  )
```

```{r}
dbo23 %>%
  filter(location2 == "DBO_1") %>%
  filter(reads > 0) %>%
  group_by(extraction_ID) %>%
  mutate(sum=sum(reads)) %>%
  mutate(prop = reads/sum) %>%
  ggplot(aes(x=extraction_ID, y=prop, fill=taxon)) +
  geom_bar(stat = "identity") + 
  theme_bw() +
  facet_grid(~location1, scales = "free_x") + 
  labs(
    y = "relative read abundance (%)",
    x = "sample ID",
    title = "DBO Station 1 - 2023") + 
  theme(
    axis.text.x = element_text(angle = 90, hjust = 0.95),
    legend.text = element_text(size = 8),
    legend.key.size = unit(0.3, "cm"),
    legend.position = "bottom",
    legend.title = element_blank()
  )
```

summary table of reads at station1 
```{r}
dbo23 %>%
  filter(location2 == "DBO_1") %>%
  filter(sample_type == "sample") %>%
  filter(reads > 0) %>%
  group_by(taxon) %>%
  summarize(n_reads = sum(reads)) %>%
  arrange(desc(n_reads))
```

plot station2
```{r}
dbo23 %>%
  filter(location2 == "DBO_2") %>%
  filter(reads > 0) %>%
  ggplot(aes(x=extraction_ID, y=reads, fill=taxon)) +
  geom_bar(stat = "identity") + 
  theme_bw() +
  facet_grid(~location1, scales = "free_x") + 
  labs(
    y = "number of sequencing reads",
    x = "sample ID",
    title = "DBO Station 2 - 2023") + 
  theme(
    axis.text.x = element_text(angle = 90, hjust = 0.95),
    legend.text = element_text(size = 8),
    legend.key.size = unit(0.3, "cm"),
    legend.position = "bottom",
    legend.title = element_blank()
  )
```



```{r}
dbo23 %>%
  filter(location2 == "DBO_2") %>%
  filter(reads > 0) %>%
  group_by(extraction_ID) %>%
  mutate(sum=sum(reads)) %>%
  mutate(prop = reads/sum) %>%
  ggplot(aes(x=extraction_ID, y=prop, fill=taxon)) +
  geom_bar(stat = "identity") + 
  theme_bw() +
  facet_grid(~location1, scales = "free_x") + 
  labs(
    y = "relative read abundance (%)",
    x = "sample ID",
    title = "DBO Station 2 - 2023") + 
  theme(
    axis.text.x = element_text(angle = 90, hjust = 0.95),
    legend.text = element_text(size = 8),
    legend.key.size = unit(0.3, "cm"),
    legend.position = "bottom",
    legend.title = element_blank()
  )
```

```{r}
dbo23 %>%
  filter(location2 == "DBO_2") %>%
  filter(sample_type == "sample") %>%
  filter(reads > 0) %>%
  group_by(taxon) %>%
  summarize(n_reads = sum(reads)) %>%
  arrange(desc(n_reads))
```


plot station3
```{r}
dbo23 %>%
  filter(location2 == "DBO_3") %>%
  filter(reads > 0) %>%
  ggplot(aes(x=extraction_ID, y=reads, fill=taxon)) +
  geom_bar(stat = "identity") + 
  theme_bw() +
  facet_grid(~location1, scales = "free_x") + 
  labs(
    y = "number of sequencing reads",
    x = "sample ID",
    title = "DBO Station 3 - 2023") + 
  theme(
    axis.text.x = element_text(angle = 90, hjust = 0.95),
    legend.text = element_text(size = 8),
    legend.key.size = unit(0.3, "cm"),
    legend.position = "bottom",
    legend.title = element_blank()
  )
```



```{r}
dbo23 %>%
  filter(location2 == "DBO_3") %>%
  filter(reads > 0) %>%
  group_by(extraction_ID) %>%
  mutate(sum=sum(reads)) %>%
  mutate(prop = reads/sum) %>%
  ggplot(aes(x=extraction_ID, y=prop, fill=taxon)) +
  geom_bar(stat = "identity") + 
  theme_bw() +
  facet_grid(~location1, scales = "free_x") + 
  labs(
    y = "relative read abundance (%)",
    x = "sample ID",
    title = "DBO Station 3 - 2023") + 
  theme(
    axis.text.x = element_text(angle = 90, hjust = 0.95),
    legend.text = element_text(size = 8),
    legend.key.size = unit(0.3, "cm"),
    legend.position = "bottom",
    legend.title = element_blank()
  )
```

```{r}
dbo23 %>%
  filter(location2 == "DBO_3") %>%
  filter(sample_type == "sample") %>%
  filter(reads > 0) %>%
  group_by(taxon) %>%
  summarize(n_reads = sum(reads)) %>%
  arrange(desc(n_reads))
```




plot station4
```{r}
dbo23 %>%
  filter(location2 == "DBO_4") %>%
  filter(reads > 0) %>%
  ggplot(aes(x=extraction_ID, y=reads, fill=taxon)) +
  geom_bar(stat = "identity") + 
  theme_bw() +
  facet_grid(~location1, scales = "free_x") + 
  labs(
    y = "number of sequencing reads",
    x = "sample ID",
    title = "DBO Station 4 - 2023") + 
  theme(
    axis.text.x = element_text(angle = 90, hjust = 0.95),
    legend.text = element_text(size = 8),
    legend.key.size = unit(0.3, "cm"),
    legend.position = "bottom",
    legend.title = element_blank()
  )
```



```{r}
dbo23 %>%
  filter(location2 == "DBO_4") %>%
  filter(reads > 0) %>%
  group_by(extraction_ID) %>%
  mutate(sum=sum(reads)) %>%
  mutate(prop = reads/sum) %>%
  ggplot(aes(x=extraction_ID, y=prop, fill=taxon)) +
  geom_bar(stat = "identity") + 
  theme_bw() +
  facet_grid(~location1, scales = "free_x") + 
  labs(
    y = "relative read abundance (%)",
    x = "sample ID",
    title = "DBO Station 4 - 2023") + 
  theme(
    axis.text.x = element_text(angle = 90, hjust = 0.95),
    legend.text = element_text(size = 8),
    legend.key.size = unit(0.3, "cm"),
    legend.position = "bottom",
    legend.title = element_blank()
  )
```

```{r}
dbo23 %>%
  filter(location2 == "DBO_4") %>%
  filter(sample_type == "sample") %>%
  filter(reads > 0) %>%
  group_by(taxon) %>%
  summarize(n_reads = sum(reads)) %>%
  arrange(desc(n_reads))
```




plot station1 
```{r}
dbo23 %>%
  filter(location2 == "DBO_5") %>%
  filter(reads > 0) %>%
  ggplot(aes(x=extraction_ID, y=reads, fill=taxon)) +
  geom_bar(stat = "identity") + 
  theme_bw() +
  facet_grid(~location1, scales = "free_x") + 
  labs(
    y = "number of sequencing reads",
    x = "sample ID",
    title = "DBO Station 5 - 2023") + 
  theme(
    axis.text.x = element_text(angle = 90, hjust = 0.95),
    legend.text = element_text(size = 8),
    legend.key.size = unit(0.3, "cm"),
    legend.position = "bottom",
    legend.title = element_blank()
  )
```



```{r}
dbo23 %>%
  filter(location2 == "DBO_5") %>%
  filter(reads > 0) %>%
  group_by(extraction_ID) %>%
  mutate(sum=sum(reads)) %>%
  mutate(prop = reads/sum) %>%
  ggplot(aes(x=extraction_ID, y=prop, fill=taxon)) +
  geom_bar(stat = "identity") + 
  theme_bw() +
  facet_grid(~location1, scales = "free_x") + 
  labs(
    y = "relative read abundance (%)",
    x = "sample ID",
    title = "DBO Station 5 - 2023") + 
  theme(
    axis.text.x = element_text(angle = 90, hjust = 0.95),
    legend.text = element_text(size = 8),
    legend.key.size = unit(0.3, "cm"),
    legend.position = "bottom",
    legend.title = element_blank()
  )
```

```{r}
dbo23 %>%
  filter(location2 == "DBO_5") %>%
  filter(sample_type == "sample") %>%
  filter(reads > 0) %>%
  group_by(taxon) %>%
  summarize(n_reads = sum(reads)) %>%
  arrange(desc(n_reads))
```




plot moorings (?)
```{r}
dbo23 %>%
  filter(location2 %in% c("BF2", "CK9", "M8")) %>%
  filter(reads > 0) %>%
  ggplot(aes(x=extraction_ID, y=reads, fill=taxon)) +
  geom_bar(stat = "identity") + 
  theme_bw() +
  facet_grid(~location1, scales = "free_x") + 
  labs(
    y = "number of sequencing reads",
    x = "sample ID",
    title = "DBO BF2/CK9/M8 - 2023") + 
  theme(
    axis.text.x = element_text(angle = 90, hjust = 0.95),
    legend.text = element_text(size = 8),
    legend.key.size = unit(0.3, "cm"),
    legend.position = "bottom",
    legend.title = element_blank()
  )
```



```{r}
dbo23 %>%
  filter(location2 %in% c("BF2", "CK9", "M8")) %>%
  filter(reads > 0) %>%
  group_by(extraction_ID) %>%
  mutate(sum=sum(reads)) %>%
  mutate(prop = reads/sum) %>%
  ggplot(aes(x=extraction_ID, y=prop, fill=taxon)) +
  geom_bar(stat = "identity") + 
  theme_bw() +
  facet_grid(~location1, scales = "free_x") + 
  labs(
    y = "relative read abundance (%)",
    x = "sample ID",
    title = "DBO BF2/CK9/M8 - 2023") + 
  theme(
    axis.text.x = element_text(angle = 90, hjust = 0.95),
    legend.text = element_text(size = 8),
    legend.key.size = unit(0.3, "cm"),
    legend.position = "bottom",
    legend.title = element_blank()
  )
```

```{r}
dbo23 %>%
  filter(location2 %in% c("BF2", "CK9", "M8")) %>%
  filter(sample_type == "sample") %>%
  filter(reads > 0) %>%
  group_by(taxon, location1) %>%
  summarize(n_reads = sum(reads)) %>%
  arrange(desc(n_reads))
```


plot BS
```{r}
dbo23 %>%
  filter(location2 == "BS") %>%
  filter(reads > 0) %>%
  ggplot(aes(x=extraction_ID, y=reads, fill=taxon)) +
  geom_bar(stat = "identity") + 
  theme_bw() +
  facet_grid(~location1, scales = "free_x") + 
  labs(
    y = "number of sequencing reads",
    x = "sample ID",
    title = "DBO BS - 2023") + 
  theme(
    axis.text.x = element_text(angle = 90, hjust = 0.95),
    legend.text = element_text(size = 8),
    legend.key.size = unit(0.3, "cm"),
    legend.position = "bottom",
    legend.title = element_blank()
  )
```

```{r}
dbo23 %>%
  filter(location2 == "BS") %>%
  filter(reads > 0) %>%
  group_by(extraction_ID) %>%
  mutate(sum=sum(reads)) %>%
  mutate(prop = reads/sum) %>%
  ggplot(aes(x=extraction_ID, y=prop, fill=taxon)) +
  geom_bar(stat = "identity") + 
  theme_bw() +
  facet_grid(~location1, scales = "free_x") + 
  labs(
    y = "relative read abundance (%)",
    x = "sample ID",
    title = "DBO BS - 2023") + 
  theme(
    axis.text.x = element_text(angle = 90, hjust = 0.95),
    legend.text = element_text(size = 8),
    legend.key.size = unit(0.3, "cm"),
    legend.position = "bottom",
    legend.title = element_blank()
  )
```

```{r}
dbo23 %>%
  filter(location2 == "BS") %>%
  filter(sample_type == "sample") %>%
  filter(reads > 0) %>%
  group_by(taxon) %>%
  summarize(n_reads = sum(reads)) %>%
  arrange(desc(n_reads))
```



plot IC
```{r}
dbo23 %>%
  filter(location2 == "IC") %>%
  filter(reads > 0) %>%
  ggplot(aes(x=extraction_ID, y=reads, fill=taxon)) +
  geom_bar(stat = "identity") + 
  theme_bw() +
  facet_grid(~location1, scales = "free_x") + 
  labs(
    y = "number of sequencing reads",
    x = "sample ID",
    title = "DBO IC - 2023") + 
  theme(
    axis.text.x = element_text(angle = 90, hjust = 0.95),
    legend.text = element_text(size = 8),
    legend.key.size = unit(0.3, "cm"),
    legend.position = "bottom",
    legend.title = element_blank()
  )
```



```{r}
dbo23 %>%
  filter(location2 == "IC") %>%
  filter(reads > 0) %>%
  group_by(extraction_ID) %>%
  mutate(sum=sum(reads)) %>%
  mutate(prop = reads/sum) %>%
  ggplot(aes(x=extraction_ID, y=prop, fill=taxon)) +
  geom_bar(stat = "identity") + 
  theme_bw() +
  facet_grid(~location1, scales = "free_x") + 
  labs(
    y = "relative read abundance (%)",
    x = "sample ID",
    title = "DBO IC - 2023") + 
  theme(
    axis.text.x = element_text(angle = 90, hjust = 0.95),
    legend.text = element_text(size = 8),
    legend.key.size = unit(0.3, "cm"),
    legend.position = "bottom",
    legend.title = element_blank()
  )
```

```{r}
dbo23 %>%
  filter(location2 == "IC") %>%
  filter(sample_type == "sample") %>%
  filter(reads > 0) %>%
  group_by(taxon) %>%
  summarize(n_reads = sum(reads)) %>%
  arrange(desc(n_reads))
```